#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Environment variables.

export QT_QUICK_CONTROLS_STYLE=org.kde.breeze


# -- Input validation.

if [ -z "${1-}" ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

FILE_PATH="$1"

if [ ! -e "$FILE_PATH" ]; then
    echo "Error: File not found: $FILE_PATH"
    exit 1
fi

FILENAME=$(basename "$FILE_PATH")
MIME_TYPE=$(file --mime-type -b "$FILE_PATH" 2>/dev/null || printf '%s' "application/octet-stream")


# -- Identify the actual user.

REAL_USER="${SUDO_USER:-$USER}"


# -- Logging.

LOGDIR=/var/log/nitrux
LOGFILE="$LOGDIR/hcvl-file-interceptor.log"
if [ -w "/var/log" ]; then
    mkdir -p "$LOGDIR" 2>/dev/null || true
fi


# -- Metadata.

dist=$(grep '^PRETTY_NAME=' /etc/os-release 2>/dev/null | head -n1 | cut -d= -f2- | tr -d '"' || true)
dist=${dist:-Nitrux}
software_management_url='https://nxos.org/tutorial/software-management/'
vendor='Nitrux Latinoamericana S.C.'
fecha=$(date +%Y)


# -- Colors for CLI fallback.

BOLD='\e[1m'
UNDERLINE='\e[4m'
NF='\e[0m'
WHITE='\033[1;37m'
YELLOW='\033[1;33m'
NC='\033[0m'


# -- Functions.

block_legacy() {
    if [ -w "$LOGDIR" ]; then
        printf '%s BLOCKED: %s FILE: %s USER: %s\n' "$(date -Iseconds)" "LEGACY_PKG" "$FILENAME" "$REAL_USER" >>"$LOGFILE" 2>/dev/null || true
    fi

    TITLE="Restricted Format: $FILENAME"
    
    MSG="<b><tt>$FILENAME</tt> cannot be installed directly.</b><br><br>"
    MSG+="Using legacy package formats on the host undermines system integrity.<br><br>"
    MSG+="The preferred ways to install software are:<br><br>"
    MSG+="&nbsp;&bull;&nbsp;<b>AppBox</b><br>"
    MSG+="&nbsp;&bull;&nbsp;<b>Flatpak</b><br>"
    MSG+="&nbsp;&bull;&nbsp;<b>Distrobox</b><br><br>"
    MSG+="For details, see the documentation:<br><br>"
    MSG+="&nbsp;&bull;&nbsp;<b>Software Management: $software_management_url</b><br>"
    MSG+="<hr><b>The file was not opened.</b>"

    if [ "$EUID" -ne 0 ] && [ -n "${DISPLAY-}" ] && command -v kdialog >/dev/null 2>&1; then
        kdialog --title "$TITLE" --icon "system-software-install" --msgbox "$MSG" --geometry 600x400
    else
        show_cli_fallback "Restricted Format" "Usage of $FILENAME is not supported on the host system."
    fi
    exit 1
}

warn_appimage() {
    if [ -w "$LOGDIR" ]; then
        printf '%s WARNING: %s FILE: %s USER: %s\n' "$(date -Iseconds)" "UNMANAGED_APPIMAGE" "$FILENAME" "$REAL_USER" >>"$LOGFILE" 2>/dev/null || true
    fi

    TITLE="Unmanaged Software: $FILENAME"
    
    MSG="<b><tt>$FILENAME</tt> is an unmanaged AppImage.</b><br><br>"
    MSG+="Nitrux guarantees stability and performance only for software running inside managed <b>AppBoxes</b>.<br><br>"
    MSG+="Running unmanaged binaries may introduce instability or unexpected behavior.<br><br>"
    MSG+="&nbsp;&bull;&nbsp;<b>Recommended:</b> Create a custom AppBox to run this application safely.<br>"
    MSG+="<hr><b>Do you still want to execute this file?</b>"

    # CRITICAL FIX: Check EUID != 0.
    if [ "$EUID" -ne 0 ] && [ -n "${DISPLAY-}" ] && command -v kdialog >/dev/null 2>&1; then
        kdialog --title "$TITLE" \
                --icon "dialog-warning" \
                --yes-label "Execute" \
                --no-label "Cancel" \
                --geometry 600x350 \
                --warningyesno "$MSG"
        
        if [ $? -eq 0 ]; then
            chmod +x "$FILE_PATH"
            "$FILE_PATH" &
            exit 0
        fi
        exit 1
    else
        echo -e "${YELLOW}Warning: Running unmanaged AppImage: $FILENAME${NC}"
        chmod +x "$FILE_PATH"
        "$FILE_PATH"
    fi
}


show_cli_fallback() {
    local header="$1"
    local message="$2"
    
    echo ' '
    echo '                          =                  '
    echo '                          =     .            '
    echo '                          =     .:::         '
    echo '::+.      ....:......     =         :::      '
    echo '%+-#=  ..:    :-:    .    =            :::.  '
    echo '--#-=-- --    .:#---.     =            .=#%#='
    echo '- .**=#= :      *    .    =         :+#%%%#=.'
    echo '-   -# =#.    --     .    =      :+%%%%*-.   '
    echo '        ..  ..  ....      =   -+%%%%*-       '
    echo '                          =-*%%%%+:          '
    echo '                          +%%#+:             '
    echo ' '
    echo ' '
    echo -e "$dist"
    echo ' '
    echo -e "(c) $fecha Some Rights Reserved. Made by $vendor"
    echo ' '
    echo ' '
    echo -e "${YELLOW}#####################################################${NC}"
    echo -e "${YELLOW}# $header #${NC}"
    echo -e "${YELLOW}#####################################################${NC}"
    echo ' '
    echo -e "$message"
    echo ' '
    echo -e "Nitrux focuses on user-centric, rootless software management."
    echo ' '
    echo -e "Use ${BOLD}AppBoxes${NF}, ${BOLD}Flatpak${NF}, or ${BOLD}Distrobox${NF}."
    echo ' '
    echo -e "For details, see the documentation:"
    echo -e "  ${WHITE}${UNDERLINE}$software_management_url${NC}${NF}"
    echo ' '
}


# -- Block legacy packages.

case "$MIME_TYPE" in
    "application/vnd.debian.binary-package"|"application/x-debian-package"|"application/x-rpm")
        block_legacy
        ;;
    
    "application/x-iso9660-appimage"|"application/vnd.appimage")
        warn_appimage
        ;;
        
    *)
        if [[ "$FILE_PATH" == *.deb ]] || [[ "$FILE_PATH" == *.rpm ]]; then
            block_legacy
        elif [[ "$FILE_PATH" == *.AppImage ]] || [[ "$FILE_PATH" == *.appimage ]]; then
            warn_appimage
        else
            /usr/bin/xdg-open "$FILE_PATH"
        fi
        ;;
esac
