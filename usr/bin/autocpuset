#!/usr/bin/env bash

#############################################################################################################################################################################
#   The license used for this file and its contents is: BSD-3-Clause                                                                                                        #
#                                                                                                                                                                           #
#   Copyright <2025> <Uri Herrera <uri_herrera@nxos.org>>                                                                                                                   #
#                                                                                                                                                                           #
#   Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:                          #
#                                                                                                                                                                           #
#    1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.                                        #
#                                                                                                                                                                           #
#    2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer                                      #
#       in the documentation and/or other materials provided with the distribution.                                                                                         #
#                                                                                                                                                                           #
#    3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software                    #
#       without specific prior written permission.                                                                                                                          #
#                                                                                                                                                                           #
#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,                      #
#    THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS                  #
#    BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE                 #
#    GOODS OR SERVICES; LOSS OF USE, DATA,   OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,                      #
#    STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.   #
#############################################################################################################################################################################


# Applies cpuset isolation using the same housekeeping cores; moves background tasks away from game cores


# -- Exit on errors.

set -euo pipefail


# -- Configuration.

CONFIG_FILE="/etc/conf.d/cpuset-balance"


# -- Functions.

expand_list() {
    echo "$1" | tr ',' '\n' | while read -r range; do
        if [[ "$range" == *-* ]]; then
            # It's a range like "0-15", use seq
            seq "${range%-*}" "${range#*-*}"
        else
            # It's a single number like "8", just echo it
            echo "$range"
        fi
    done | LC_ALL=C sort
}

detect_housekeeping_cores() {
    if [ -r /etc/conf.d/irq-pin ]; then
        # shellcheck source=/dev/null
        . /etc/conf.d/irq-pin
        
        if [ -n "${DEVICES:-}" ]; then
            local oifs="$IFS"; IFS=','
            
            for d in $DEVICES; do 
                local var_name
                var_name="CPUSET_${d}"
                
                local cpus="${!var_name:-}" 
                
                if [ -n "$cpus" ]; then
                    echo "$cpus"
                    IFS="$oifs"
                    return
                fi
            done
            IFS="$oifs"
        fi
    fi
    
    echo " ! irq-pin config not found or empty, using fallback." >&2
    
    local last
    last="$(tr ',' '\n' < /sys/devices/system/cpu/online | cut -d'-' -f2 | sort -nr | head -n1)"

    if [ -z "$last" ]; then
        echo " ! Failed to find last online CPU." >&2
        return 1
    fi
    
    cat "/sys/devices/system/cpu/cpu${last}/topology/thread_siblings_list"
}

ALL_CORES_ONLINE="$(cat /sys/devices/system/cpu/online)"
HOUSEKEEPING_CORES="$(detect_housekeeping_cores)"

if [ -z "$HOUSEKEEPING_CORES" ]; then
    echo " ! Failed to determine housekeeping cores." >&2
    exit 1
fi


# -- Check permissions.

if [ "$EUID" -ne 0 ]; then
  echo "This script must be run as root." >&2
  exit 1
fi


# -- Correctly calculate GAME_CORES using set subtraction.

ALL_CORES_EXPANDED=$(expand_list "$ALL_CORES_ONLINE")
HK_CORES_EXPANDED=$(expand_list "$HOUSEKEEPING_CORES")

GAME_CORES_LIST=$(LC_ALL=C comm -23 <(echo "$ALL_CORES_EXPANDED") <(echo "$HK_CORES_EXPANDED"))

GAME_CORES=$(echo "$GAME_CORES_LIST" | tr '\n' ',' | sed 's/,$//')

if [ -z "$GAME_CORES" ]; then
    echo " ! Failed to calculate game cores (result was empty)." >&2
    exit 1
fi

ONLINE_CORES_EXPANDED=$(expand_list "$ALL_CORES_ONLINE")

HOUSEKEEPING_CORES_FINAL_LIST=$(LC_ALL=C comm -12 <(echo "$HK_CORES_EXPANDED") <(echo "$ONLINE_CORES_EXPANDED"))
GAME_CORES_FINAL_LIST=$(LC_ALL=C comm -12 <(echo "$GAME_CORES_LIST") <(echo "$ONLINE_CORES_EXPANDED"))

HOUSEKEEPING_CORES=$(echo "$HOUSEKEEPING_CORES_FINAL_LIST" | tr '\n' ',' | sed 's/,$//')
GAME_CORES=$(echo "$GAME_CORES_FINAL_LIST" | tr '\n' ',' | sed 's/,$//')

if [ -z "$HOUSEKEEPING_CORES" ] || [ -z "$GAME_CORES" ]; then
    echo " ! Fatal: Clamping to online CPUs resulted in an empty core list." >&2
    exit 1
fi


# -- Write configuration.

mkdir -p /etc/conf.d
cat > "$CONFIG_FILE" <<EOF
# Auto-generated by autohousekeeping on $(date)
HOUSEKEEPING_CORES="$HOUSEKEEPING_CORES"
GAME_CORES="$GAME_CORES"
EOF

echo " * Housekeeping cores: $HOUSEKEEPING_CORES"
echo " * Game/Performance cores: $GAME_CORES"
echo " * Configuration written to $CONFIG_FILE"


# -- Apply cpusets.

BASE=/sys/fs/cgroup

mount -t cgroup2 none "$BASE" 2>/dev/null || true

printf +cpuset > "$BASE/cgroup.subtree_control" 2>/dev/null || true

mkdir -p "$BASE/housekeeping" "$BASE/game"

MEMS=$(cat "$BASE/cpuset.mems")

if [ -z "$MEMS" ]; then
    echo " ! Fatal: Could not read root cpuset.mems. Aborting." >&2
    exit 1
fi

printf %s "$MEMS" > "$BASE/housekeeping/cpuset.mems"
printf %s "$MEMS" > "$BASE/game/cpuset.mems"

printf %s "$HOUSEKEEPING_CORES" > "$BASE/housekeeping/cpuset.cpus"
printf %s "$GAME_CORES" > "$BASE/game/cpuset.cpus"

printf member > "$BASE/housekeeping/cpuset.cpus.partition" 2>/dev/null || true
printf member > "$BASE/game/cpuset.cpus.partition" 2>/dev/null || true

echo " * Moving system daemons and kernel threads to housekeeping..."

printf 1 > "$BASE/housekeeping/cgroup.procs" 2>/dev/null || true
printf 2 > "$BASE/housekeeping/cgroup.procs" 2>/dev/null || true

echo " * Applied cpuset isolation."
