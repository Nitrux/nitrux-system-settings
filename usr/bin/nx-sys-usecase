#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2024-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Environment variables.

export QT_QUICK_CONTROLS_STYLE=org.kde.breeze


# -- Notify users that running the distribution on a VM or low-spec hardware is *NOT THE INTENDED USE CASE*.

IS_VM=0

if [ -r /sys/class/dmi/id/product_name ]; then
    PRODUCT_NAME=$(cat /sys/class/dmi/id/product_name)
    if echo "$PRODUCT_NAME" | grep -qiE "VirtualBox|VMware|KVM|Bochs|QEMU|Standard PC|Virtual Machine"; then
        IS_VM=1
    fi
fi

if grep -q "hypervisor" /proc/cpuinfo; then
    IS_VM=1
fi

if [ "$IS_VM" -eq 0 ]; then
    TOTAL_RAM_MB=$(awk '/MemTotal/ {printf "%d", $2 / 1024}' /proc/meminfo)
    TOTAL_RAM_GB=$(awk '/MemTotal/ {printf "%.1f", $2 / 1024 / 1024}' /proc/meminfo)
    PHYSICAL_CORES=$(lscpu | grep "^Core(s) per socket:" | awk '{print $4}')
    THREADS=$(lscpu | grep "^CPU(s):" | awk '{print $2}')

    LOW_RAM=0
    LOW_CORES=0
    LOW_THREADS=0

    if (( TOTAL_RAM_MB < 4096 )); then
        LOW_RAM=1
    fi
    if (( PHYSICAL_CORES < 4 )); then
        LOW_CORES=1
    fi
    if (( THREADS < 4 )); then
        LOW_THREADS=1
    fi

    if (( LOW_RAM || LOW_CORES || LOW_THREADS )); then
        notify-send \
            -a "System Message" \
            -u critical \
            --action=Understood \
            -i "dialog-warning" \
            "System Specs Warning" \
            "This system does not meet the minimum recommended specifications. Dismiss to view details."

        TABLE_ROWS=""

        if (( LOW_RAM )); then
            TABLE_ROWS+="<tr style='background-color: #ffcccc;'><td>RAM</td><td>4 GB</td><td>$TOTAL_RAM_GB GB</td></tr>"
        else
            TABLE_ROWS+="<tr><td>RAM</td><td>4 GB</td><td>$TOTAL_RAM_GB GB</td></tr>"
        fi

        if (( LOW_CORES )); then
            TABLE_ROWS+="<tr style='background-color: #ffcccc;'><td>Physical Cores</td><td>4</td><td>$PHYSICAL_CORES</td></tr>"
        else
            TABLE_ROWS+="<tr><td>Physical Cores</td><td>4</td><td>$PHYSICAL_CORES</td></tr>"
        fi

        if (( LOW_THREADS )); then
            TABLE_ROWS+="<tr style='background-color: #ffcccc;'><td>Threads</td><td>4</td><td>$THREADS</td></tr>"
        else
            TABLE_ROWS+="<tr><td>Threads</td><td>4</td><td>$THREADS</td></tr>"
        fi

        MSG="<p>This system does not meet the minimum recommended hardware specifications that we consider necessary to run Nitrux without harming the user experience. We highlight the components that do not meet the requirements.</p>"
        MSG+="<table border='1' cellpadding='5'>"
        MSG+="<tr><th>Component</th><th>Required</th><th>Detected</th></tr>"
        MSG+="$TABLE_ROWS"
        MSG+="</table><br>"
        MSG+="<p>Performance will be limited. Nitrux does not target low-spec hardware.</p>"
        MSG+="<p>Please review the documentation:<br>"
        MSG+="<b>System Requirements: https://nxos.org/tutorial/how-to-install-nitrux/#system-requirements/</b></p>"

        kdialog --title "System Specs Warning" --msgbox "$MSG" --geometry 550x350
    fi

    exit 0
fi

sleep 5

notify-send \
    --app-name="System Message" \
    --urgency=critical \
    --icon="dialog-warning" \
    --wait \
    --action="Understood=Understood" \
    "VM Detected" \
    "Nitrux is running in a Virtual Machine; performance and experience will be severely limited.\n\nDismiss this notification to view the virtualization policy."

TITLE="Virtualizing Nitrux"

MSG="We have discontinued integration and support features intended for running Nitrux as a guest OS. While Nitrux will continue to run in most hypervisors, components such as SPICE integration, the QXL X.Org driver, and the Hyper-V modules, daemons, and OpenRC services are no longer included.<br><br>"
MSG+="Despite our previous efforts to provide guidance, we repeatedly encountered users applying incorrect configurations, further limiting performance in already-constrained virtualized environments, among other issues stemming from hypervisor quirks.<br><br>"
MSG+="<b>We never intended Virtual Machines to be the platform for using Nitrux.</b><br><br>"
MSG+="Nitrux is tuned and optimized for physical systems, where users can experience its design, performance, and intent as we built it.<br><br>"
MSG+="Please review the documentation:<br><br>"
MSG+="<b>System Requirements: https://nxos.org/tutorial/how-to-install-nitrux/#system-requirements/</b><br><br>"
MSG+="<font color='orange'><b>⚠️ Important:</b></font> Bug reports regarding running Nitrux as a guest VM will be closed.<br><br>"
MSG+="<hr><b>The system will now reboot.</b>"

kdialog --title "$TITLE" --msgbox "$MSG" --geometry 600x400

loginctl reboot || hyprctl dispatch exit
